<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta property="og:title" content="M.I.A - Th·ª≠ v·∫≠n may rinh ngay ph·∫ßn th∆∞·ªüng" />
  <meta property="og:description" content="Nh·∫•n ƒë·ªÉ quay, nh·∫≠n li·ªÅn tay qu√† t·∫∑ng h·∫•p d·∫´n c√πng M.I.A" />
  <meta property="og:image"
    content="https://miawaxing.vn/wp-content/uploads/2022/09/299736667_831246341584784_346590775965623132_n-scaled.jpeg" />
  <meta property="og:url" content="https://miawaxing.vn/" />
  <meta property="og:type" content="website" />
  <title>M.I.A - Th·ª≠ v·∫≠n may rinh ngay ph·∫ßn th∆∞·ªüng</title>
  <link rel="stylesheet" href="css/typo/typo.css" />
  <link rel="stylesheet" href="css/hc-canvas-luckwheel.css" />
  <style>
    .hc-luckywheel {
      position: relative;
      top: 50%;
      left: 50%;
      transform: translateX(-50%) translateY(35%);
    }

    form {
      max-width: 600px;
      height: 75vh;
      overflow-y: auto;
      margin: 50px auto;
      padding: 20px 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      text-align: left;
      font-family: "Main Font", sans-serif;

    }

    h2 {
      font-size: 1.5em;
      font-weight: 500;
      color: #202124;
      text-align: center;
      margin-bottom: 20px;
    }

    small {
      display: block;
      font-size: 0.9em;
      color: #5f6368;
      margin-bottom: 10px;
    }

    fieldset {
      border: none;
      margin-bottom: 20px;
      padding: 0;
    }

    legend {
      font-size: 1em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-size: 1em;
      color: #202124;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 1em;
      background-color: #fff;
      color: #202124;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    input[type="radio"],
    input[type="checkbox"] {
      margin-right: 10px;
    }

    .form-group {
      margin-bottom: 10px;
    }

    .radio,
    .checkbox {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }

    button[type="submit"] {
      background-color: #4285f4;
      color: white;
      font-size: 1em;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }

    button[type="submit"]:hover {
      background-color: #357ae8;
    }

    ul {
      padding-left: 20px;
      color: #5f6368;
      font-size: 0.9em;
    }

    ul li {
      margin-bottom: 5px;
    }

    .spin-again-btn {
      background: #F5CB41;

      font-family: "Footer", sans-serif;
      color: #333;
      font-size: 28px;
      font-weight: bold;
      border-radius: 10px;
      text-decoration: none;
      padding: 2px 16px;
      cursor: pointer;
      width: fit-content;
      margin: 0px auto;
      margin-top: 50px;
    }

    .spin-again-btn:hover {
      background: #f5b700;
    }

    #preSpinForm .help-block {
      margin-top: 10px !important;
      margin-bottom: 0px !important;
    }

    .spin-counter {
      text-align: center;
      margin: 20px 0;
      font-size: 18px;
      font-weight: bold;
      color: #4285f4;
    }
  </style>
</head>

<body class="bg" style="height: 100vh !important; width: 100% !important;">
  <div class="main-content">
    <div class="img-section">
      <img src="./assests/slogan.png" alt="" class="top-img-content">
      <div class="bottom-content">
        <img src="./assests/banner.png" alt="" class="bottom-img-content">
      </div>
    </div>
    <div class="wheel-container" id="content" style="margin-bottom: 100px;">
      <form id="preSpinForm" style="display: block;">
        <h2>Nh·∫≠p th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu</h2>
        <fieldset>
          <legend>T√äN KH√ÅCH H√ÄNG</legend>
          <div class="form-group">
            <p class="help-block">V√≠ d·ª•: Nguy·ªÖn Th·ªã Kim</p>
            <input type="text" id="userName" name="userName" class="form-control" required>
          </div>
        </fieldset>
        <fieldset>
          <legend>S·ªê ƒêI·ªÜN THO·∫†I X√ÅC NH·∫¨N</legend>
          <div class="form-group">
            <input type="tel" id="phoneNumber" name="phoneNumber" class="form-control" required pattern="[0-9]{10}">
          </div>
        </fieldset>
        <fieldset>
          <legend>S·ªê L∆Ø·ª¢T QUAY</legend>
          <div class="form-group">
            <input type="number" id="spinLimit" name="spinLimit" class="form-control" required min="1">
          </div>
        </fieldset>
        <button type="submit" class="btn btn-primary">B·∫Øt ƒë·∫ßu quay</button>
      </form>
      <div class="typo" id="wrapper" style="display: none;">
        <div id="luckywheel" class="hc-luckywheel">
          <div style="position: relative;">
            <div class="hc-luckywheel-container">
              <canvas class="hc-luckywheel-canvas" width="500px" height="500px">V√≤ng Xoay May M·∫Øn</canvas>
            </div>
            <div style="position: relative; margin: 15px;">
              <img src="./assests/wheel.png" alt="" style="position: absolute;" class="wheel">
            </div>
          </div>
          <div class="hc-luckywheel-pointer"></div>
          <a class="hc-luckywheel-btn" href="javascript:;">
            <p>B·∫ÆT<br />ƒê·∫¶U<br />CH∆†I</p>
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="overlay" id="popupOverlay">
    <div class="popup">
      <div id="popupInformation-1-1" style="display: none;">
        <img src="./assests/Icon TruÃÅng thuÃõoÃõÃâng.png" alt="üéâ" class="win-icon">
        <div class="title">Ch√∫c m·ª´ng b·∫°n nh·∫≠n ƒë∆∞·ª£c</div>
        <div class="prize" id="prizeText"></div>
        <img id="prizeImage" src="" alt="MIA Device">
        <a class="btn" id="completeBtn" style="display: none;" onclick="completeAndSubmit()">Ho√†n th√†nh</a>
        <a class="spin-again-btn" id="spinAgainBtn" style="display: none;" onclick="spinAgain()">Quay ti·∫øp</a>
      </div>
      <div class="subtitle" id="popupInformation-1-2" style="display: none;">Tr∆∞·ªùng h·ª£p xu·∫•t hi·ªán 2 gi·∫£i th∆∞·ªüng c√πng m√£
        (code) ho·∫∑c<br />m√£ kh√¥ng h·ª£p l·ªá, gi·∫£i th∆∞·ªüng s·∫Ω ƒë∆∞·ª£c xem l√† kh√¥ng h·ª£p l·ªá.</div>
      <form
        action="https://docs.google.com/forms/d/e/1FAIpQLSeycRl-4YwCpkI6h5NqlEN7JUGs-bz4rCdgOW2TVtfoVKoogA/formResponse"
        target="_self" id="bootstrapForm-1" method="POST" style="display: none;">
        <fieldset>
          <h2>ƒêI·ªÄN TH√îNG TIN NH·∫¨N QU√Ä 21.12</h2>
          <small>
            Qu√Ω kh√°ch h√†ng l∆∞u √Ω:
            <ul>
              <li>Ph·∫ßn qu√† h·ª£p l·ªá l√† ph·∫ßn qu√† ƒë∆∞·ª£c quay 1 l·∫ßn duy nh·∫•t cho m·ªói ID kh√°ch h√†ng, M.I.A lo·∫°i b·ªè nh·ªØng ph·∫ßn
                qu√† c√≥ tr√πng ID v·ªõi ph·∫ßn qu√† ƒë·∫ßu ti√™n m√† kh√°ch h√†ng nh·∫≠n ƒë∆∞·ª£c</li>
              <li>Ph·∫ßn qu√† h·ª£p l·ªá l√† ph·∫ßn qu√† c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng, trong tr∆∞·ªùng h·ª£p chuy√™n vi√™n M.I.A kh√¥ng
                th·ªÉ li√™n l·∫°c ƒë∆∞·ª£c v·ªõi kh√°ch h√†ng tr√∫ng th∆∞·ªüng b·ªüi nguy√™n nh√¢n: s·ªë ƒëi·ªán tho·∫°i kh√¥ng ch√≠nh ch·ªß ho·∫∑c kh√¥ng
                li√™n l·∫°c ƒë∆∞·ª£c; kh√°ch h√†ng kh√¥ng th·ªÉ ƒë·∫øn nh·∫≠n trong th·ªùi gian quy ƒë·ªãnh; v.v... ph·∫ßn qu√† s·∫Ω t√≠nh l√† kh√¥ng
                h·ª£p l·ªá.</li>
              <li>M·ªói ph·∫ßn th∆∞·ªüng s·∫Ω c√≥ c√°ch th·ª©c trao gi·∫£i v√† th·ªùi h·∫°n s·ª≠ d·ª•ng kh√°c nhau, qu√Ω kh√°ch vui l√≤ng ƒë·ªÉ √Ω ƒëi·ªán
                tho·∫°i ƒë·ªÉ ƒë∆∞·ª£c chuy√™n vi√™n M.I.A h∆∞·ªõng d·∫´n nh·∫≠n th∆∞·ªüng theo ƒë√∫ng quy tr√¨nh.</li>
              <li>M.I.A s·∫Ω kh√¥ng gi·∫£i quy·∫øt b·∫•t k√¨ ph√°t sinh n√†o trong qu√° tr√¨nh kh√°ch h√†ng tham gia quay th∆∞·ªüng.</li>
            </ul>
          </small>
        </fieldset>


        <!-- Field type: "short" id: "797639794" -->
        <fieldset>
          <legend for="797639794">T√äN KH√ÅCH H√ÄNG</legend>
          <div class="form-group">
            <p class="help-block">V√≠ d·ª•: Nguy·ªÖn Th·ªã Kim
            </p>
            <input id="795063311" type="text" name="entry.795063311" class="form-control" required>
          </div>
        </fieldset>


        <!-- Field type: "short" id: "181428271" -->
        <fieldset>
          <legend for="181428271">S·ªê ƒêI·ªÜN THO·∫†I X√ÅC NH·∫¨N</legend>
          <div class="form-group">
            <input id="733058814" type="text" name="entry.733058814" class="form-control" required>
          </div>
        </fieldset>


        <!-- Field type: "short" id: "1739187403" -->
        <fieldset>
          <legend for="1739187403">PH·∫¶N QU√Ä NH·∫¨N ƒê∆Ø·ª¢C</legend>
          <div class="form-group">
            <input id="12181340" type="text" name="entry.12181340" class="form-control">
          </div>
        </fieldset>

        <input type="hidden" name="fvv" value="1">
        <input type="hidden" name="fbzx" value="-7279449895537479914">
        <!--
        CAVEAT: In multipages (multisection) forms, *pageHistory* field tells to google what sections we've currently completed.
        This usually starts as "0" for the first page, then "0,1" in the second page... up to "0,1,2..N" in n-th page.
        Keep this in mind if you plan to change this code to recreate any sort of multipage-feature in your exported form.
        We're setting this to the total number of pages in this form because we're sending all fields from all the section together.
    -->
        <input type="hidden" name="pageHistory" value="0">

        <input class="btn btn-primary" type="submit" value="Submit">
      </form>
    </div>
  </div>
  <div class="overlay" id="popupOverlayOutOfTurn">
    <div class="popup">
      <div id="popupInformation-2-1">
        <img src="./assests/Icon heÃÇÃÅt luÃõoÃõÃ£t quay.png" alt="üéâ" class="win-icon">
        <div class="title">H·∫æT L∆Ø·ª¢T QUAY</div>
        <div class="subtitle">R·∫•t ti·∫øc, b·∫°n ƒë√£ h·∫øt l∆∞·ª£t quay. Vui l√≤ng li√™n h·ªá nh√¢n vi√™n ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ th√™m!</div>
        <a class="btn" onclick="closeModal()">ƒê√≥ng</a>
      </div>
    </div>
  </div>
  <div class="overlay" id="popupOverlayOutOfQuantity">
    <div class="popup">
      <div id="popupInformation-2-1">
        <img src="./assests/Icon heÃÇÃÅt luÃõoÃõÃ£t quay.png" alt="üéâ" class="win-icon">
        <div class="title">H·∫æT PH·∫¶N QU√Ä</div>
        <div class="subtitle">R·∫•t ti·∫øc, s·ªë l∆∞·ª£ng ph·∫ßn qu√† ƒë√£ h·∫øt. Vui l√≤ng li√™n h·ªá nh√¢n vi√™n ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ th√™m!</div>
        <a class="btn" onclick="closeModal()">ƒê√≥ng</a>
      </div>
    </div>
  </div>
  <audio allow="autoplay" loop src="./assests/nhacNen.mp3" id="wheel-background-music"></audio>
  <audio src="./assests/MIA WAX LOÃÇNG.mp3" id="wheel-rotate-music"></audio>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.2.2/jquery.form.min.js"
    integrity="sha256-2Pjr1OlpZMY6qesJM68t2v39t+lMLvxwpa8QlRjJroA=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="js/hc-canvas-luckwheel.js"></script>
  <script src="js/form-handler.js" defer></script>
  <script>
    var isPercentage = true;
    const prizes = [
      { text: "Voucher gi·∫£m gi√° 50k", number: 95, percentpage: 0.65, img: './assests/gifts/voucher50k.png' },
      { text: "Voucher gi·∫£m gi√° 100k", number: 40, percentpage: 0.25, img: './assests/gifts/voucher100k.png' },
      { text: "Voucher gi·∫£m gi√° 200k", number: 30, percentpage: 0.15, img: './assests/gifts/voucher200k.png' },
      { text: "Voucher gi·∫£m gi√° 300k", number: 20, percentpage: 0.1, img: './assests/gifts/voucher300k.png' },
      { text: "Voucher gi·∫£m gi√° 500k", number: 10, percentpage: 0.1, img: './assests/gifts/voucher500k.png' },
      { text: "Voucher gi·∫£m gi√° 50k", number: 95, percentpage: 0.65, img: './assests/gifts/voucher50k.png' },
      { text: "Voucher gi·∫£m gi√° 1000k", number: 5, percentpage: 0.05, img: './assests/gifts/voucher1000k.png' },
      { text: "Voucher gi·∫£m gi√° 3999k", number: 0, percentpage: 0, img: './assests/gifts/voucher3999k.png' },
    ];
    window.prizes = prizes;

    // Initialize prize quantities in localStorage if not already set
    function initializePrizeQuantities() {
      try {
        const storedPrizes = JSON.parse(localStorage.getItem("prizeQuantities"));
        if (!storedPrizes) {
          const initialQuantities = prizes.map(prize => ({ text: prize.text, number: prize.number }));
          localStorage.setItem("prizeQuantities", JSON.stringify(initialQuantities));
          console.log("Initialized prize quantities in localStorage:", initialQuantities);
        }
      } catch (error) {
        console.error("Error initializing prize quantities in localStorage:", error);
        Swal.fire({
          icon: 'error',
          title: 'L·ªói h·ªá th·ªëng',
          text: 'Kh√¥ng th·ªÉ truy c·∫≠p b·ªô nh·ªõ tr√¨nh duy·ªát. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá h·ªó tr·ª£!',
        });
      }
    }

    // Get current prize quantities from localStorage
    function getPrizeQuantities() {
      try {
        return JSON.parse(localStorage.getItem("prizeQuantities")) || prizes.map(prize => ({ text: prize.text, number: prize.number }));
      } catch (error) {
        console.error("Error retrieving prize quantities from localStorage:", error);
        return prizes.map(prize => ({ text: prize.text, number: prize.number }));
      }
    }

    // Update prize quantity in localStorage after awarding
    function updatePrizeQuantity(prizeText) {
      try {
        const storedPrizes = getPrizeQuantities();
        const updatedPrizes = storedPrizes.map(p => {
          if (p.text === prizeText && p.number > 0) {
            return { ...p, number: p.number - 1 };
          }
          return p;
        });
        localStorage.setItem("prizeQuantities", JSON.stringify(updatedPrizes));
        console.log("Updated prize quantities in localStorage:", updatedPrizes);
      } catch (error) {
        console.error("Error updating prize quantities in localStorage:", error);
        Swal.fire({
          icon: 'error',
          title: 'L·ªói h·ªá th·ªëng',
          text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ph·∫ßn qu√†. Vui l√≤ng th·ª≠ l·∫°i!',
        });
      }
    }

    function getSpinData() {
      return JSON.parse(sessionStorage.getItem("spinData")) || {};
    }

    function setSpinData(data) {
      sessionStorage.setItem("spinData", JSON.stringify(data));
    }

    function getCurrentUserSpins() {
      const phoneNumber = sessionStorage.getItem("currentPhoneNumber");
      if (!phoneNumber) return null;
      const spinData = getSpinData();
      return spinData[phoneNumber] || null;
    }

    function updateSpinCounter() {
      const userSpins = getCurrentUserSpins();
      const counterElement = document.getElementById("spinCounter");
      if (userSpins && counterElement) {
        counterElement.textContent = `C√≤n l·∫°i: ${userSpins.spinsLeft} l∆∞·ª£t`;
      }
    }

    document.getElementById("preSpinForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const userName = document.getElementById("userName").value.trim();
      const phoneNumber = document.getElementById("phoneNumber").value.trim();
      const spinLimit = parseInt(document.getElementById("spinLimit").value);

      if (!userName || !phoneNumber || isNaN(spinLimit) || spinLimit <= 0) {
        Swal.fire({
          icon: 'error',
          title: 'L·ªói',
          text: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin h·ª£p l·ªá (t√™n, s·ªë ƒëi·ªán tho·∫°i, s·ªë l∆∞·ª£t quay ph·∫£i l·ªõn h∆°n 0)!',
        });
        console.error('Validation failed: userName:', userName, 'phoneNumber:', phoneNumber, 'spinLimit:', spinLimit);
        return;
      }

      const phonePattern = /^[0-9]{10}$/;
      if (!phonePattern.test(phoneNumber)) {
        Swal.fire({
          icon: 'error',
          title: 'L·ªói',
          text: 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i g·ªìm 10 ch·ªØ s·ªë v√† kh√¥ng ch·ª©a k√Ω t·ª± ƒë·∫∑c bi·ªát!',
        });
        console.error('Invalid phone number format:', phoneNumber);
        return;
      }

      // Check session storage availability
      try {
        const testKey = '__test__';
        sessionStorage.setItem(testKey, testKey);
        sessionStorage.removeItem(testKey);
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'L·ªói h·ªá th·ªëng',
          text: 'Kh√¥ng th·ªÉ truy c·∫≠p b·ªô nh·ªõ tr√¨nh duy·ªát. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá h·ªó tr·ª£!',
        });
        console.error('Session storage error:', error);
        return;
      }

      // Check localStorage availability
      try {
        const testKey = '__test__';
        localStorage.setItem(testKey, testKey);
        localStorage.removeItem(testKey);
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'L·ªói h·ªá th·ªëng',
          text: 'Kh√¥ng th·ªÉ truy c·∫≠p b·ªô nh·ªõ tr√¨nh duy·ªát. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá h·ªó tr·ª£!',
        });
        console.error('Local storage error:', error);
        return;
      }

      // Check if phone number already exists
      const spinData = getSpinData();
      if (spinData[phoneNumber]) {
        Swal.fire({
          icon: 'error',
          title: 'S·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng',
          text: 'S·ªë ƒëi·ªán tho·∫°i n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω. Vui l√≤ng s·ª≠ d·ª•ng s·ªë ƒëi·ªán tho·∫°i kh√°c!',
        });
        console.warn('Duplicate phone number detected:', phoneNumber);
        return;
      }

      // Store user data and proceed
      try {
        sessionStorage.setItem("currentPhoneNumber", phoneNumber);
        sessionStorage.setItem("currentUserName", userName);

        spinData[phoneNumber] = {
          name: userName,
          spinsLeft: spinLimit,
          totalSpins: spinLimit
        };
        setSpinData(spinData);

        sessionStorage.removeItem("wonPrizes");

        document.getElementById("preSpinForm").style.display = "none";
        document.getElementById("wrapper").style.display = "block";
        updateSpinCounter();

        // Initialize prize quantities in localStorage
        initializePrizeQuantities();

        console.log(`Initialized user ${userName} (${phoneNumber}) with ${spinLimit} spins`);
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'L·ªói h·ªá th·ªëng',
          text: 'ƒê√£ x·∫£y ra l·ªói khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i!',
        });
        console.error('Error during form submission:', error);
      }
    });

    document.addEventListener("DOMContentLoaded", async function () {
      // Initialize prize quantities on page load
      initializePrizeQuantities();

      const initData = prizes;

      hcLuckywheel.init({
        id: "luckywheel",
        config: function (callback) {
          callback && callback(initData);
        },
        mode: "text",
        getPrize: function (callback) {
          const userSpins = getCurrentUserSpins();

          if (!userSpins || userSpins.spinsLeft <= 0) {
            console.log("No spins left before spinning - showing out of turn modal");
            document.getElementById("popupOverlayOutOfTurn").style.display = "flex";
            document.getElementById("content").classList.add("blur");
            return;
          }

          const availablePrizes = getPrizeQuantities().filter(prize => prize.number > 0);
          if (availablePrizes.length === 0) {
            console.log("No prizes available - showing out of quantity modal");
            document.getElementById("popupOverlayOutOfQuantity").style.display = "flex";
            document.getElementById("content").classList.add("blur");
            return;
          }

          console.log(`User has ${userSpins.spinsLeft} spins left before spinning`);

          var rand = randomIndex(initData);
          var chances = rand !== null ? rand : 0;
          callback && callback([rand, chances]);
        },
        gotBack: function (data) {
          if (data) {
            const userSpins = getCurrentUserSpins();
            if (!userSpins || userSpins.spinsLeft <= 0) {
              console.log("No spins left - this shouldn't happen");
              return;
            }

            // Update prize quantity in localStorage
            updatePrizeQuantity(data.text);

            let wonPrizes = JSON.parse(sessionStorage.getItem("wonPrizes")) || [];
            wonPrizes.push(data);
            sessionStorage.setItem("wonPrizes", JSON.stringify(wonPrizes));

            const prizeText = wonPrizes.map(prize => prize.text).join(", ");
            document.getElementById("prizeText").textContent = prizeText;
            document.getElementById("prizeImage").src = data.img;
            document.getElementById("12181340").value = prizeText;

            // Decrement spins
            const spinData = getSpinData();
            const phoneNumber = sessionStorage.getItem("currentPhoneNumber");
            spinData[phoneNumber].spinsLeft -= 1;
            setSpinData(spinData);

            const remainingSpins = spinData[phoneNumber].spinsLeft;
            console.log(`Spins remaining after this spin: ${remainingSpins}`);

            updateSpinCounter();

            confetti({
              zIndex: 99999,
              particleCount: 500,
              startVelocity: 30,
              spread: 360,
            });

            showPrizeModal(data, remainingSpins);
          }
        }
      });
    }, false);

    function showPrizeModal(data, remainingSpins) {
      document.getElementById("popupInformation-1-1").style.display = "block";
      document.getElementById("popupInformation-1-2").style.display = "block";

      const completeBtn = document.getElementById("completeBtn");
      const spinAgainBtn = document.getElementById("spinAgainBtn");

      if (remainingSpins === 0) {
        completeBtn.style.display = "block";
        spinAgainBtn.style.display = "none";
        console.log("Last spin completed - showing Complete button");
      } else {
        completeBtn.style.display = "none";
        spinAgainBtn.style.display = "block";
        console.log(`${remainingSpins} spins remaining - showing Spin Again button"`);
      }

      document.getElementById("popupOverlay").style.display = "flex";
      document.getElementById("content").classList.add("blur");
    }

    function completeAndSubmit() {
      const userName = sessionStorage.getItem("currentUserName");
      const phoneNumber = sessionStorage.getItem("currentPhoneNumber");
      const prizeText = document.getElementById("12181340").value;

      // Auto-fill required form fields with minimal data
      const form = document.getElementById("bootstrapForm-1");
      document.getElementById("795063311").value = userName || "Kh√°ch h√†ng";
      document.getElementById("733058814").value = phoneNumber || "";
      document.getElementById("12181340").value = prizeText;

      // Create a hidden iframe for form submission
      const iframeId = 'hiddenIframe-' + new Date().getTime();
      const iframe = document.createElement("iframe");
      iframe.id = iframeId;
      iframe.name = iframeId;
      iframe.style.display = "none";
      document.body.appendChild(iframe);

      // Set form target to iframe
      form.setAttribute("target", iframeId);

      // Submit form
      form.submit();

      // Handle submission completion
      iframe.onload = function () {
        setTimeout(() => {
          closeModal();
          Swal.fire({
            title: 'Th√†nh c√¥ng',
            text: 'M.I.A ƒë√£ nh·∫≠n ƒë∆∞·ª£c th√¥ng tin c·ªßa b·∫°n.',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false,
          }).then(() => {
            sessionStorage.clear();
            let wonPrizes = JSON.parse(sessionStorage.getItem("wonPrizes")) || [];
            wonPrizes.forEach(prize => updatePrizeQuantity(prize.text));
            document.getElementById("popupOverlay").style.display = "none";
            document.getElementById("content").classList.remove("blur");
            document.getElementById("bootstrapForm-1").style.display = "none";
            document.getElementById("bootstrapForm-1").reset();
            document.getElementById("preSpinForm").style.display = "block";
            document.getElementById("preSpinForm").reset();
            document.getElementById("wrapper").style.display = "none";
            const rotateAudio = document.querySelector('#wheel-rotate-music');
            pauseAudio('#wheel-rotate-music');
            rotateAudio.currentTime = 0;
            confetti({
              particleCount: 500,
              startVelocity: 30,
              spread: 360,
            });
            iframe.remove();
          });
        }, 1000);
      };
    }

    function closeModal() {
      document.getElementById("prizeImage").classList.remove("rotate");
      document.getElementById("popupOverlay").style.display = "none";
      document.getElementById("popupOverlayOutOfTurn").style.display = "none";
      document.getElementById("popupOverlayOutOfQuantity").style.display = "none";
      document.getElementById("content").classList.remove("blur");
    }

    function spinAgain() {
      closeModal();
    }

    function showForm() {
      document.getElementById("popupInformation-1-1").style.display = "none";
      document.getElementById("popupInformation-1-2").style.display = "none";
      document.getElementById("bootstrapForm-1").style.display = "block";

      const userName = sessionStorage.getItem("currentUserName");
      const phoneNumber = sessionStorage.getItem("currentPhoneNumber");

      if (userName) {
        document.getElementById("919986610").value = userName;
      }
      if (phoneNumber) {
        document.getElementById("1469647055").value = phoneNumber;
      }
    }

    function randomIndex(prizes) {
      const userSpins = getSpinData();
      if (!userSpins || userSpins.spinsLeft <= 0) {
        console.log("No spins available for random selection");
        return null;
      }

      // Get available prizes from localStorage
      const storedPrizes = getPrizeQuantities();
      const availablePrizes = prizes
        .map((prize, index) => ({ ...prize, index }))
        .filter(prize => {
          const storedPrize = storedPrizes.find(p => p.text === prize.text);
          return storedPrize && storedPrize.number > 0;
        });

      if (availablePrizes.length === 0) {
        console.log("No available prizes");
        return null;
      }

      // Calculate total probability
      const totalPercent = availablePrizes.reduce((sum, prize) => sum + prize.percentpage, 0);
      if (totalPercent === 0) {
        console.log("Total percent is zero, no valid prizes");
        return null;
      }

      // Normalize probabilities
      const normalizedPrizes = availablePrizes.map(prize => ({
        ...prize,
        normalizedPercent: prize.percentpage / totalPercent
      }));

      // Generate random number
      let rand = Math.random();
      let cumulativePercent = 0;

      // Select prize based on normalized probability
      for (let i = 0; i < normalizedPrizes.length; i++) {
        cumulativePercent += normalizedPrizes[i].normalizedPercent;
        if (rand <= cumulativePercent) {
          return normalizedPrizes[i].index;
        }
      }

      // Fallback
      return availablePrizes[availablePrizes.length - 1].index;
    }

    function playAudio(id) {
      const audio = document.querySelector(id);
      if (audio) {
        audio.play().catch(error => {
          console.warn(`Failed to play audio ${id}:`, error);
        });
      }
    }

    function pauseAudio(id) {
      const audio = document.querySelector(id);
      if (audio) {
        audio.pause();
      }
    }
  </script>
</body>

</html>